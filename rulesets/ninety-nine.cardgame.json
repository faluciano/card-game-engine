{
  "$schema": "../packages/schema/src/schema/cardgame.v1.schema.json",
  "meta": {
    "name": "Ninety-Nine",
    "slug": "ninety-nine",
    "version": "1.0.0",
    "author": "faluciano",
    "players": {
      "min": 2,
      "max": 4
    },
    "description": "Accumulation card game where players add to a running total and try not to exceed 99",
    "tags": ["accumulation", "avoidance", "classic", "math"],
    "license": "public-domain"
  },
  "deck": {
    "preset": "standard_52",
    "copies": 1,
    "cardValues": {
      "A":  { "kind": "fixed", "value": 1 },
      "2":  { "kind": "fixed", "value": 2 },
      "3":  { "kind": "fixed", "value": 3 },
      "4":  { "kind": "fixed", "value": 0 },
      "5":  { "kind": "fixed", "value": 5 },
      "6":  { "kind": "fixed", "value": 6 },
      "7":  { "kind": "fixed", "value": 7 },
      "8":  { "kind": "fixed", "value": 8 },
      "9":  { "kind": "fixed", "value": 0 },
      "10": { "kind": "fixed", "value": 10 },
      "J":  { "kind": "fixed", "value": 10 },
      "Q":  { "kind": "fixed", "value": 10 },
      "K":  { "kind": "fixed", "value": 0 }
    }
  },
  "zones": [
    {
      "name": "draw_pile",
      "visibility": { "kind": "hidden" },
      "owners": []
    },
    {
      "name": "hand",
      "visibility": { "kind": "owner_only" },
      "owners": ["player"]
    },
    {
      "name": "discard",
      "visibility": { "kind": "public" },
      "owners": []
    }
  ],
  "roles": [
    {
      "name": "player",
      "isHuman": true,
      "count": "per_player"
    }
  ],
  "initialVariables": {
    "running_total": 0,
    "bust_player": -1
  },
  "phases": [
    {
      "name": "setup",
      "kind": "automatic",
      "actions": [],
      "transitions": [
        { "to": "player_turns", "when": "all_hands_dealt" }
      ],
      "automaticSequence": [
        "shuffle(draw_pile)",
        "deal(draw_pile, hand, 3)"
      ]
    },
    {
      "name": "player_turns",
      "kind": "turn_based",
      "actions": [
        {
          "name": "play",
          "label": "Play Top Card",
          "effect": [
            "set_var(\"bust_player\", current_player_index)",
            "if(card_rank_name(current_player.hand, 0) == \"4\", reverse_turn_order())",
            "if(card_rank_name(current_player.hand, 0) == \"9\", set_var(\"running_total\", 99))",
            "if(card_rank_name(current_player.hand, 0) == \"10\", inc_var(\"running_total\", -10))",
            "if(card_rank_name(current_player.hand, 0) != \"4\" && card_rank_name(current_player.hand, 0) != \"9\" && card_rank_name(current_player.hand, 0) != \"10\" && card_rank_name(current_player.hand, 0) != \"K\", inc_var(\"running_total\", card_rank(current_player.hand, 0)))",
            "move_top(current_player.hand, discard, 1)",
            "if(card_count(draw_pile) > 0, draw(draw_pile, current_player.hand, 1))",
            "end_turn()"
          ]
        }
      ],
      "transitions": [
        { "to": "scoring", "when": "get_var(\"running_total\") > 99" },
        { "to": "scoring", "when": "card_count(\"draw_pile\") == 0 && card_count(\"hand:0\") == 0" }
      ],
      "turnOrder": "clockwise"
    },
    {
      "name": "scoring",
      "kind": "automatic",
      "actions": [],
      "transitions": [
        { "to": "round_end", "when": "scores_calculated" }
      ],
      "automaticSequence": [
        "calculate_scores()",
        "determine_winners()"
      ]
    },
    {
      "name": "round_end",
      "kind": "all_players",
      "actions": [
        {
          "name": "play_again",
          "label": "Play Again",
          "effect": [
            "collect_all_to(draw_pile)",
            "reset_round()"
          ]
        }
      ],
      "transitions": [
        { "to": "setup", "when": "continue_game" }
      ]
    }
  ],
  "scoring": {
    "method": "if(current_player_index == get_var(\"bust_player\"), 0, 1)",
    "winCondition": "my_score > 0",
    "bustCondition": "false",
    "tieCondition": "false"
  },
  "visibility": [
    {
      "zone": "draw_pile",
      "visibility": { "kind": "hidden" }
    },
    {
      "zone": "hand",
      "visibility": { "kind": "owner_only" }
    },
    {
      "zone": "discard",
      "visibility": { "kind": "public" }
    }
  ],
  "ui": {
    "layout": "circle",
    "tableColor": "felt_green"
  }
}
